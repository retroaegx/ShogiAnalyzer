# 引き継ぎ書 (2026-02-26)

## 現状

- `shogi_kifu_analyzer_design.md` を読んで、設計に沿った最小構成を実装済み
- `Sample` から以下をコピー済み
  - `server/assets_web/board-theme/` (盤テーマ画像・設定)
  - `server/assets_web/js/vendor/sfen.js`
  - `server/assets_web/js/vendor/usi.js`
  - `server/assets_web/js/vendor/shogiCoords.js`
  - `server/assets_web/js/vendor/themeLoader.js`
  - 参照用: `docs/reference_sample/ShogiBoard.jsx`
- Python側は `.venv` を作成済み（`E:\work\ShogiAnalyzer\.venv`）

## 実装済み範囲（最小）

- FastAPI 前提のサーバ骨格
  - HTTP: `/`, `/healthz`, `/api/current`, `/api/games`, `/api/import`, `/api/export/{game_id}`
  - WebSocket: `/ws`（単一セッション `busy/takeover`、`game:new/load/save`, `node:play_move/jump` など最低限）
- SQLite 永続化
  - `games`, `nodes`, `analysis_snapshots`, `app_state`
- 分岐ゲーム木（USI move 追加/ジャンプ/子順序変更/コメント）
- USI import/export
  - `position startpos moves ...`
  - `position sfen ... moves ...`
- 静的UI（ビルド不要）
  - 盤面描画（`Sample` の `sfen.js` でSFEN解析）
  - WS接続・セッション奪取
  - 手入力USI追加、USIインポート、USIエクスポート、保存一覧ロード
- KIF/KIF2 import/export はスタブ（エラーメッセージ返却）
- エンジン解析は未実装（スタブ）

## 実行時に止まった理由（依存不足）

`2026-02-26` に以下を実行:

```powershell
python installer/run.py
```

結果:

```text
ModuleNotFoundError: No module named 'fastapi'
```

この環境では「直接ライブラリをインストールしない」指示に従い、ここで停止。

## ユーザー側で実施する手順（Windows / PowerShell）

1. 仮想環境の pip を更新

```powershell
E:\work\ShogiAnalyzer\.venv\Scripts\python.exe -m pip install -U pip
```

2. 必要ライブラリを仮想環境へインストール

```powershell
E:\work\ShogiAnalyzer\.venv\Scripts\python.exe -m pip install -r E:\work\ShogiAnalyzer\server\requirements.txt
```

3. サーバ起動

```powershell
E:\work\ShogiAnalyzer\.venv\Scripts\python.exe E:\work\ShogiAnalyzer\installer\run.py
```

4. ブラウザ確認

- `http://127.0.0.1:31145`
- `http://127.0.0.1:31145/healthz`

## 起動後の動作確認チェック（最小）

1. ページが開く（盤面が表示される）
2. `WS connected` になる
3. `New` で新規ゲームが作れる
4. `USI move` に `7g7f` を入力して `Play`
5. `USI move` に `3c3d` を入力して `Play`
6. `Prev` / `Next` が動く
7. `Import text` に以下を入れて `Import`

```text
position startpos moves 7g7f 3c3d 2g2f
```

8. `Export` を `USI` にして `Download`

## 依存導入後に起こり得る追加バグ（再開時の優先確認）

- FastAPI / Uvicorn 起動時の import エラー
- StaticFiles 配信（`/` は開くが `/board-theme/...` が404）
- WebSocket `/ws` 接続エラー
- `PUT /api/games/{id}` / `POST /api/import` のJSON処理周り
- `themeLoader.js` の `import.meta` 挙動（ブラウザ差）

## 依存なしで確認済み（AI実行済み）

- `python -m compileall server installer`
- コアスモーク（USI move適用、ゲーム木、SQLite保存/復元）

## 主なファイル

- `server/app/main.py`
- `server/app/api.py`
- `server/app/ws.py`
- `server/app/core/gametree.py`
- `server/app/core/sfen_ops.py`
- `server/app/services/state_store.py`
- `server/assets_web/index.html`
- `server/assets_web/js/app.js`
- `installer/run.py`

---

## 2回目実行メモ (2026-02-26)

### 実施内容
- `.venv` 上の依存確認: `fastapi`, `uvicorn` は導入済み（前回停止理由は解消済み）
- `installer/run.py` で起動確認を実施
- 失敗ログ解析 → 修正 → 再実行 → スモークテスト成功まで完了

### 発生した失敗
- `installer/run.py` が `uvicorn --reload` で起動しており、この実行環境（Windows / 制限付き実行）で `multiprocessing` が Named Pipe 作成時に失敗
- エラー例:
  - `PermissionError: [WinError 5] アクセスが拒否されました。`
  - 発生元: `multiprocessing.resource_sharer` (`uvicorn --reload` のリローダー系)

### 修正内容
- `installer/run.py`
  - デフォルト起動から `--reload` を外した
  - 環境変数 `SHOGI_ANALYZER_RELOAD=1`（または `true/yes/on`）のときのみ `--reload` を有効化

### 再実行結果（成功）
- `installer/run.py` 起動成功
- スモークテスト（同一PowerShellセッション内で起動→検証→停止）成功:
  - `GET /healthz` -> `200`
  - `GET /` -> `200`
  - `GET /js/app.js` -> `200`
  - `GET /board-theme/config.json` -> `200`
  - `GET /api/current` -> `200`
  - `GET /api/games` -> `200`
  - `POST /api/import` (USI) -> `200`
  - `GET /api/export/{game_id}?format=usi` -> `200`
  - `POST /api/games` -> `200`
  - `PUT /api/games/{id}` -> `200`
  - `DELETE /api/games/{id}` -> `200`
- USI import/export 確認:
  - 入力: `position startpos moves 7g7f 3c3d 2g2f`
  - 出力: `position startpos moves 7g7f 3c3d 2g2f`

### 補足
- この環境では「別プロセスでサーバを常駐 → 後続コマンドから叩く」方式が安定しないため、検証は同一PowerShellセッション内で `Start-Process` して API 疎通確認後に停止する方法を使った
